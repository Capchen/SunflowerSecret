---
title: 'äº§å“æ¨¡å—æ¥å…¥è¯´æ˜' # å½“å‰é¡µé¢å†…å®¹æ ‡é¢˜ï¼Œé»˜è®¤ä¸º Markdown æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ª h1 æ ‡ç­¾å†…å®¹
shortTitle: 'å·¥ç¨‹æ¥å…¥' # å½“å‰é¡µé¢çš„çŸ­æ ‡é¢˜
description: 'emotibotçš„äº§å“æ¨¡å—æ¥å…¥è¯´æ˜' # å½“å‰é¡µé¢å†…å®¹æè¿°
icon: '' # å½“å‰é¡µé¢å›¾æ ‡çš„ FontClass æˆ–æ–‡ä»¶è·¯å¾„ (å»ºè®®å¡«å†™)ã€‚
author: {
  name: 'Cap'
}
isOriginal: true # å½“å‰æ–‡ç« æ˜¯å¦ä¸ºåŸåˆ›ã€‚
date: 2022-08-23 # å†™ä½œæ—¶é—´ã€‚
category: 'åŸºå»ºğŸ¤º' # åˆ†ç±»
tag: 'cli' # æ ‡ç­¾
sticky: 1 # æ˜¯å¦åœ¨åˆ—è¡¨ä¸­ç½®é¡¶ã€‚å½“å¡«å…¥æ•°å­—æ—¶ï¼Œæ•°å­—è¶Šå¤§ï¼Œæ’åè¶Šé å‰
star: false # æ˜¯å¦æ”¶è—åœ¨åšå®¢ä¸»é¢˜çš„æ–‡ç« åˆ—è¡¨ä¸­ã€‚å½“å¡«å…¥æ•°å­—æ—¶ï¼Œæ•°å­—è¶Šå¤§ï¼Œæ’åè¶Šé å‰ã€‚
article: true # æ˜¯å¦å°†è¯¥æ–‡ç« æ·»åŠ è‡³æ–‡ç« åˆ—è¡¨ä¸­
timeline: true # æ˜¯å¦å°†è¯¥æ–‡ç« æ·»åŠ è‡³æ—¶é—´çº¿ä¸­

---

## è¯´æ˜

äº§å“æ¨¡å—æ¥å…¥æ˜¯æŒ‡åœ¨ `BF2020`Â ä¸­ï¼Œå¢åŠ ä¸€ä¸ªæœåŠ¡æ¨¡å—ã€‚ä»¥ä¸­æ§æ¨¡å—ï¼ˆccmï¼‰ä¸ºä¾‹ï¼Œå¦‚å›¾ï¼š
![image.png](/assets/images/CLI/1592273834835-a00be586-dd93-4431-8107-55e677ecad1e.png)
åœ¨é€‰æ‹©ä¼ä¸šä¹‹åï¼Œå·¦ä¾§ä¼šå‡ºç°ä¼ä¸šæœ‰æƒé™ä½¿ç”¨çš„äº§å“æœåŠ¡ï¼Œç°æœ‰ä¹ä¸ªã€‚æˆ‘ä»¬çš„äº§å“æ¨¡å—æ¥å…¥ï¼Œå°±æ˜¯éœ€è¦åœ¨ä¹‹åå¢åŠ ä¸€ä¸ªäº§å“æ¨¡å—å…¥å£ã€‚

## å‡†å¤‡é˜¶æ®µ

æˆ‘ä»¬ä½¿ç”¨ `emoti-cli`Â æ­å»ºæ–°çš„UIå·¥ç¨‹ã€‚ä½¿ç”¨æ–¹å¼å‚è€ƒ[README.md](https://gitlab.emotibot.com/emoti_frontend/emoti-cli)
> æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä½¿ç”¨çš„æ˜¯bf2020_productæ¨¡ç‰ˆ

å¹¶ä¸”è¿˜éœ€è¦åœ¨ `emotibot_deploy`Â éƒ¨ç½²å·¥ç¨‹ä¸­åŠ å…¥æ–°çš„æ¨¡å—ã€‚

æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸­æ§æ¨¡å—UIå·¥ç¨‹å’Œç°æœ‰çš„äº§å“UIå·¥ç¨‹çš„å…³ç³»ã€‚
ä¸‹å›¾è¡¨ç¤ºæ¯ä¸ªäº§å“å¯¹åº”ä¸€ä¸ªä»£ç å·¥ç¨‹ã€‚
![image.png](/assets/images/CLI/1592275210087-a6a4830c-f19d-4198-af84-fa91d6ff872b.png)

äº§å“æ¨¡å—æ˜¯å¦‚ä½•è¢«è®¿é—®åŠå¦‚ä½•è¯·æ±‚åå°æœåŠ¡çš„ï¼Ÿä¸‹å›¾è¡¨ç¤ºä¸€ä¸ªè¯·æ±‚çš„è¿‡ç¨‹ï¼š
![image.png](/assets/images/CLI/1592275571887-8e420077-90fe-4304-b60d-b8a219fa1197.png#align=left&display=inline&height=381&name=image.png&originHeight=446&originWidth=819&size=34526&status=done&style=none&width=699)

æ€»ç»“ï¼šæ–°çš„äº§å“UIå·¥ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬é€šè¿‡`emotibot_deploy`éƒ¨ç½²å·¥ç¨‹çš„è®¾ç½®ç›¸äº’å…³è”ã€‚

## UIå·¥ç¨‹

é€šè¿‡`emoti-cli`æ¨¡ç‰ˆæ­å»ºçš„é¡¹ç›®å°±å·²ç»èƒ½è¿›è¡Œæœ¬åœ°å¼€å‘äº†ã€‚
å…¥å£æ–‡ä»¶æ˜¯ï¼š
![image.png](/assets/images/CLI/1592277241475-dd841cc7-0b31-41c0-bb18-fc9479fb8ef6.png#align=left&display=inline&height=97&name=image.png&originHeight=180&originWidth=386&size=14474&status=done&style=none&width=207)

- bf2020_auth.js: å®šä¹‰äº†ä¸€äº›åŸºç¡€æ¥å£ï¼Œä¾‹å¦‚è·å–äº§å“åˆ—è¡¨ï¼Œè·å–ä¼šè¯ç»´åº¦ç­‰
- FrameworkProduct.vue: åŸºç¡€ç•Œé¢ï¼ŒåŒ…å«å³ä¾§äº§å“åˆ—è¡¨ï¼Œé¡¶éƒ¨å·¥å…·æ ç­‰
- request.js: å°è£…çš„è¯·æ±‚æ¥å£

ä¸šåŠ¡ä»£ç å¼€å‘å®Œæ¯•ï¼Œå°±å¯ä»¥è¿›è¡Œæ„å»ºéƒ¨ç½²äº†

### dockeræ„å»ºè®¾ç½®

![image.png](/assets/images/CLI/1592278053195-f7af78ee-7269-4e5f-945c-a0640e544a4b.png#align=left&display=inline&height=359&name=image.png&originHeight=876&originWidth=354&size=55816&status=done&style=none&width=145)
ä¸Šå›¾çš„dockerç›®å½•æ˜¯æ¨¡ç‰ˆå·¥ç¨‹å¸¦å…¥çš„ï¼Œdocker_newæ˜¯ä¸­æ§æ¨¡å—ç°åœ¨é‡‡ç”¨çš„ã€‚ä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ˜¯docker_newä½¿ç”¨çš„æ˜¯æ–°çš„åŸºç¡€é•œåƒï¼Œæ˜¯å‚ç…§è¿ç»´åŒå­¦ä¼˜åŒ–åçš„é•œåƒæ¥çš„ï¼Œä½“ç§¯ä¼šæ›´å°ã€‚ï¼ˆé‡‡ç”¨å“ªç§æ–¹å¼è¿˜éœ€è¦ç¡®è®¤ä¸‹ï¼‰

#### nginx.conf.template

è®¾ç½®upstreamï¼Œå…¶ä¸­serverä»¥å˜é‡å­˜åœ¨:
![image.png](/assets/images/CLI/1592279427634-8d98b159-7f81-4609-b4c7-5f87cbd04759.png#align=left&display=inline&height=172&name=image.png&originHeight=172&originWidth=828&size=20128&status=done&style=none&width=828)
è®¾ç½®listenï¼Œç«¯å£ä¹Ÿæ˜¯ä»¥å˜é‡å­˜åœ¨ï¼š
![image.png](/assets/images/CLI/1592279566390-b69cca3f-ee89-4382-9d37-fe7b582a7379.png#align=left&display=inline&height=150&name=image.png&originHeight=150&originWidth=584&size=20708&status=done&style=none&width=584)
è®¾ç½®locationï¼š
![image.png](/assets/images/CLI/1592279490903-39bd3753-cdb7-4f7b-9c5a-78351856de51.png#align=left&display=inline&height=403&name=image.png&originHeight=558&originWidth=974&size=84900&status=done&style=none&width=703)

> ä»¥ä¸Šçš„ä¿®æ”¹ä½¿ç”¨åˆ°äº†ä¸¤ä¸ªå˜é‡ã€‚åˆ†åˆ«ä¸ºCCM_BACKEND_URL / CCM_UI_FONT_PORT

è¿™ä¸¤ä¸ªå˜é‡æˆ‘ä»¬éœ€è¦åœ¨ `entrypoint.sh`Â  ä¸­å£°æ˜ï¼Œå¹¶ä¸”éœ€è¦åœ¨deployå·¥ç¨‹ä¸­å®šä¹‰
![image.png](/assets/images/CLI/1592279746317-3387c5f5-3bd6-4f5b-9630-bd2ff802a784.png#align=left&display=inline&height=274&name=image.png&originHeight=450&originWidth=946&size=40511&status=done&style=none&width=576)

### API

![image.png](/assets/images/CLI/1592279952534-e2b7dcb7-327b-4fa7-b98b-ab7af4ccad78.png#align=left&display=inline&height=198&name=image.png&originHeight=198&originWidth=1010&size=50660&status=done&style=none&width=1010)
å¯¹äºAPIçš„URLè®¾ç½®ï¼Œæˆ‘åŠ äº†ä¸ªå‰ç¼€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦ä»¥ `./`Â ç›¸å¯¹è·¯å¾„çš„æ–¹å¼

## emotibot-loadbalance

å¯¹ç…§å‡†å¤‡é˜¶æ®µçš„è¯·æ±‚æµç¨‹å›¾ï¼šæ–°çš„è¯·æ±‚è¿›æ¥ï¼Œéœ€è¦é€šè¿‡loadbalanceçš„è½¬å‘ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¿®æ”¹loadbalanceçš„é…ç½®ã€‚

### nginx.conf.template

å¢åŠ upstream,è¿™é‡Œæœ‰ä½¿ç”¨ `LB_CCM_UI_URL`Â å˜é‡
![image.png](/assets/images/CLI/1592289281093-6738e48c-96a0-41af-b5d2-5aa1bc977d56.png#align=left&display=inline&height=656&name=image.png&originHeight=656&originWidth=800&size=88260&status=done&style=none&width=800)
å¢åŠ å¯¹ccm.htmlçš„locationè½¬å‘
![image.png](/assets/images/CLI/1592289135206-6e4dd1c0-9d5f-4127-80ab-3a313a603acd.png#align=left&display=inline&height=510&name=image.png&originHeight=510&originWidth=986&size=70294&status=done&style=none&width=986)

### entrypoint.sh

è¿™é‡Œéœ€è¦å£°æ˜å˜é‡çš„å¼•ç”¨ï¼Œå¹¶ä¸”éœ€è¦åœ¨deployå·¥ç¨‹ä¸­å®šä¹‰
![image.png](/assets/images/CLI/1592289415824-e66f3cb7-ad13-4607-a9bd-44769a8db297.png#align=left&display=inline&height=196&name=image.png&originHeight=196&originWidth=962&size=27578&status=done&style=none&width=962)

## emotibot_deploy

ä»ä¸Šæ–‡æˆ‘ä»¬æåˆ°ï¼Œemotibot_deployçš„ä¿®æ”¹ç‚¹

- å¢åŠ æ–°æ¨¡å—
- å¢åŠ å˜é‡å®šä¹‰

### å¢åŠ æ–°æ¨¡å—

![image.png](/assets/images/CLI/1592289717866-af46a642-40e5-49a7-9b47-c2ecbe146b4f.png#align=left&display=inline&height=339&name=image.png&originHeight=806&originWidth=418&size=47054&status=done&style=none&width=176)
å¢åŠ äº†ä¸€ä¸ª `10-ccm`Â çš„ç›®å½•ï¼Œé‡Œé¢å®šä¹‰äº†å…³äºccmçš„dockerå®¹å™¨ã€‚å•æœºéƒ¨ç½²ä¸»è¦å°±æ˜¯ä¿®æ”¹ä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶

- dev.env-å®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥åœ¨module.yamlæ–‡ä»¶ä¸­ä½¿ç”¨
- module.yaml-åˆ›å»ºå®¹å™¨çš„æ–‡ä»¶
- port.yaml-å®šä¹‰å„ä¸ªå®¹å™¨æš´éœ²çš„ç«¯å£

#### dev.env

å®šä¹‰ä¸€äº›å˜é‡ï¼Œè¿™é‡Œå®šä¹‰äº†ä¸­æ§çš„åç§°å’Œç«¯å£
![image.png](/assets/images/CLI/1592290344614-5cd1e3d3-f6e8-4797-838c-e99f2d1c6236.png#align=left&display=inline&height=214&name=image.png&originHeight=326&originWidth=708&size=30152&status=done&style=none&width=464)

#### module.yaml

å¢åŠ ä¸€ä¸ªä¸­æ§å®¹å™¨
![image.png](/assets/images/CLI/1592289879274-f9b03ed5-6b7e-44b2-b2a8-a522027a4e42.png#align=left&display=inline&height=337&name=image.png&originHeight=544&originWidth=1028&size=70407&status=done&style=none&width=636)

#### port.yaml

å®šä¹‰äº†ä¸¤ä¸ªå®¹å™¨çš„ç«¯å£ï¼Œéœ€è¦å”¯ä¸€
![image.png](/assets/images/CLI/1592290489914-b984706f-ee96-4aeb-aaab-26b58ccf4b17.png#align=left&display=inline&height=201&name=image.png&originHeight=358&originWidth=402&size=25085&status=done&style=none&width=226)

### å˜é‡å®šä¹‰

ä¸Šæ–‡ï¼Œæˆ‘ä»¬åœ¨ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨åˆ°äº†ç¯å¢ƒå˜é‡ã€‚ä¸€ä¸ªæ˜¯åœ¨UIå·¥ç¨‹çš„dockeræ„å»ºç›®å½•ä¸‹çš„ nginx.conf.templateæ–‡ä»¶ä¸­ï¼›ä¸€ä¸ªæ˜¯åœ¨ loadbalanceçš„nginx.conf.templateæ–‡ä»¶ä¸­
UIå·¥ç¨‹çš„å˜é‡ä¸ºCCM_BACKEND_URL / CCM_UI_FONT_PORTï¼Œè¿™ä¸¤ä¸ªå˜é‡æˆ‘ä»¬åœ¨ `module.yaml`Â æ–‡ä»¶ä¸­ `ccm-ui`Â æ¨¡å—ä¸‹çš„environmentçš„é€‰é¡¹ä¸­å®šä¹‰ã€‚å¦‚ä¸Šå›¾çš„module.yaml

> nginx.cong.templateä¸­ä½¿ç”¨çš„å˜é‡å¿…é¡»åœ¨å¯¹åº”æ¨¡å—çš„environmentä¸­å£°æ˜ï¼Œè€Œenvironmentä¸­ä½¿ç”¨çš„å˜é‡éœ€è¦åœ¨dev.envæ–‡ä»¶ä¸­å£°æ˜ã€‚nginx.cong.templateä¸­ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨dev.envä¸­çš„å˜é‡

loadbalanceçš„å˜é‡ä¸ºLB_CCM_UI_URLï¼ŒåŒæ ·ï¼Œè¿™ä¸ªå˜é‡ä¹Ÿéœ€è¦module.yamlæ–‡ä»¶ä¸­load-balanceæ¨¡å—ä¸‹çš„environmenté€‰é¡¹ä¸­å®šä¹‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ªæ˜¯åœ¨1-bfæ–‡ä»¶ä¸‹ï¼Œä¸€ä¸ªåœ¨æ–°å¢çš„æ–‡ä»¶ä¸‹ï¼ˆ10-ccmï¼‰
![image.png](/assets/images/CLI/1592291351981-8177457e-206b-4838-b1e5-be48ed695939.png#align=left&display=inline&height=756&name=image.png&originHeight=756&originWidth=1154&size=191821&status=done&style=none&width=1154)

ä¸Šå›¾å®šä¹‰çš„æ˜¯load-balanceè½¬å‘åˆ°æ–°æ¨¡å—çš„åœ°å€ç«¯å£ï¼Œè¡¨ç¤ºæœ¬åœ°çš„8909ç«¯å£ï¼Œè€Œ8909ç«¯å£æˆ‘ä»¬å·²ç»åœ¨port.yamlæ–‡ä»¶ä¸­è®¾ç½®äº†ã€‚

## init-db

ï¼ˆåœ¨éƒ¨ç½²å·¥ç¨‹ä¸‹ï¼‰
è¿™é‡Œéœ€è¦è®¾ç½®çš„æ˜¯productsæ¥å£è¿”å›çš„æ•°æ®ï¼Œåªæœ‰è¿”å›äº†æ–°çš„äº§å“ï¼Œæ‰èƒ½åœ¨å³è¾¹çš„äº§å“åˆ—è¡¨ä¸­å±•ç¤ºå…¥å£.
![image.png](/assets/images/CLI/1592291720360-2c65826f-d079-4f0e-8795-2a586b41add7.png#align=left&display=inline&height=366&name=image.png&originHeight=572&originWidth=1006&size=115718&status=done&style=none&width=644)

æ­¥éª¤å¦‚ä¸‹ï¼š

1. åœ¨1-bfæ–‡ä»¶å¤¹ä¸‹çš„init-dbæ–‡ä»¶å¤¹ä¸‹çš„sqlæ–‡ä»¶å¤¹ä¸‹çš„authæ–‡ä»¶å¤¹ä¸‹æ–°å¢ä¸€ä¸ª `.sql`Â æ–‡ä»¶

<!-- ![image.png](/assets/images/CLI/1592291943256-d5181d98-fddb-44b8-bb62-fcacc04c7718.png#align=left&display=inline&height=48&name=image.png&originHeight=48&originWidth=930&size=10645&status=done&style=none&width=930) -->

```sql
-- +migrate Up

INSERT INTO `products` (`id`, `code`, `sort`, `position`, `icon`, `route`, `is_link`, `status`, `create_time`) VALUES ('11', 'ccm', '1', 'menu_product', 'color-zhongkong', 'ccm', '1', '1', '2020-06-10 13:46:52');

INSERT INTO `ent_prods`(`ent_id`, `prod_id`) VALUES
(1, 11);

-- +migrate Down
```

2. åœ¨dockerç›®å½•ä¸‹æ‰“ä¸ªåŒ…å¹¶ä¸”push

![image.png](/assets/images/CLI/1592292123998-d056c182-7ceb-431d-bf65-76effda2ce3e.png#align=left&display=inline&height=42&name=image.png&originHeight=42&originWidth=594&size=6302&status=done&style=none&width=594)

3. ä¿®æ”¹infraç›®å½•ä¸‹çš„init-db.yamlä¸­çš„image

![image.png](/assets/images/CLI/1592292214309-5c9f7c48-34ba-4e48-b5f9-252cf3a0cdda.png#align=left&display=inline&height=95&name=image.png&originHeight=186&originWidth=1110&size=25329&status=done&style=none&width=569)

4. æœåŠ¡å™¨é‡æ–°éƒ¨ç½²

## consulæ³¨å†Œ

è¿™ä¸€æ­¥çš„æ“ä½œ
ä¸»è¦å°±æ˜¯åœ¨entrypoint.shä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œä¸»åŠ¨å»curlæ³¨å†Œä¸€ä¸ªæ–°çš„æ¨¡å—

```bash
curl ${CCM_CONSUL_URL}/v1/agent/service/register -X PUT -i -H "Content-Type:application/json" -d '{"ID":"ccm","Name":"ccm","Tags":[],"Address":"ccm-ui","Port":8909,"EnableTagOverride":false}'
```

> Addresså¡«å†™çš„æ˜¯å®¹å™¨åï¼Œå³å®šä¹‰çš„container_nameã€‚ä¹Ÿå¯ä»¥å¡«å†™å½“å‰çš„ipã€‚portå°±æ˜¯ç«¯å£

CCM_CONSUL_URLå˜é‡éœ€è¦åœ¨deployå·¥ç¨‹çš„environmenté€‰é¡¹ä¸­å£°æ˜
![image.png](/assets/images/CLI/1592447032476-de54a496-2339-45de-bce2-fc959eba94aa.png#align=left&display=inline&height=371&name=image.png&originHeight=542&originWidth=992&size=77489&status=done&style=none&width=679)
CONSUL_HOSTå’ŒCONSUL_PORTå¯ä»¥ç†è§£å·²ç»åœ¨å…¨å±€ç¯å¢ƒä¸­å®šä¹‰äº†ã€‚ç›´æ¥ä½¿ç”¨å°±å¥½äº†ã€‚

å®Œæˆä¹‹åé‡æ–°éƒ¨ç½²é¡¹ç›®ï¼Œ
[http://172.16.103.21:8500/ui/dc1/services](http://172.16.103.21:8500/ui/dc1/services)
é€šè¿‡è¿™ä¸ªåœ°å€å°±å¯ä»¥çœ‹åˆ°æ¨¡å—æ˜¯å¦å·²ç»æ³¨å†Œä¸Šå»ã€‚
> è¿™é‡Œçš„ `172.16.103.21:8500`Â æ˜¯ä¸­æ§å¼€å‘ç¯å¢ƒçš„ipå’Œç«¯å£ï¼Œéœ€è¦æ›¿æ¢æˆè‡ªå·±éƒ¨ç½²æœåŠ¡çš„ipå’Œç«¯å£
